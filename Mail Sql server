üß© Exemple de test rapide PowerShell

Pour v√©rifier si ton serveur n‚Äôaccepte que SMTPS :

Test-NetConnection smtp.exemple.com -Port 465
Test-NetConnection smtp.exemple.com -Port 587


Et pour tester STARTTLS :

openssl s_client -starttls smtp -connect smtp.exemple.com:587


Si le 587 ne r√©pond pas ou refuse STARTTLS ‚Üí Database Mail ne pourra pas se connecter directement.






‚öôÔ∏è Configuration √† utiliser dans SSMS
Champ	Valeur
Serveur SMTP	smtp.tonserveur.com
Port	587
SSL activ√©	‚úÖ Oui (case √† cocher dans le wizard Database Mail)
Authentification	Login / mot de passe de ton compte SMTP





Exemple SQL (si tu pr√©f√®res par script)
EXEC msdb.dbo.sysmail_add_account_sp
    @account_name = 'Compte_SMTP_SECURE',
    @description  = 'Compte mail SQL Server avec STARTTLS (port 587)',
    @email_address = 'sqlserver@tondomaine.com',
    @display_name  = 'SQL Server',
    @mailserver_name = 'smtp.tonserveur.com',
    @port = 587,
    @enable_ssl = 1,                -- STARTTLS
    @username = 'sqlserver@tondomaine.com',
    @password = 'TonMotDePasseIci';

‚úÖ V√©rification apr√®s test d‚Äôenvoi

Dans SSMS :

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = 'Profil_SQL_SECURE',
    @recipients = 'ton.email@exemple.com',
    @subject = '‚úÖ Test Database Mail STARTTLS (587)',
    @body = 'Email envoy√© avec chiffrement STARTTLS.';


Puis contr√¥le :

SELECT * FROM msdb.dbo.sysmail_event_log ORDER BY log_date DESC;


Si tout est bon ‚Üí tu verras :

Mail successfully sent.








-- üîç Liste des comptes Database Mail
SELECT account_id, name AS AccountName, email_address, mailserver_name, port, enable_ssl
FROM msdb.dbo.sysmail_account;

-- üîç Liste des profils Database Mail
SELECT profile_id, name AS ProfileName, description
FROM msdb.dbo.sysmail_profile;

-- üîç Association profils ‚Üî comptes
SELECT p.name AS ProfileName, a.name AS AccountName, pa.sequence_number
FROM msdb.dbo.sysmail_profileaccount pa
JOIN msdb.dbo.sysmail_profile p ON pa.profile_id = p.profile_id
JOIN msdb.dbo.sysmail_account a ON pa.account_id = a.account_id;

-- üîç V√©rifie les logs Database Mail r√©cents
SELECT TOP 20 log_date, event_type, log_id, description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;



# Test de connectivit√© r√©seau
Test-NetConnection smtp.exemple.com -Port 587

# Test de chiffrement STARTTLS avec openssl (si install√©)
openssl s_client -starttls smtp -connect smtp.exemple.com:587 -crlf -quiet


V√©rification finale (r√©sum√© rapide √† ex√©cuter)
SELECT
    a.name AS AccountName,
    a.mailserver_name AS SMTPServer,
    a.port,
    CASE a.enable_ssl WHEN 1 THEN 'STARTTLS activ√© ‚úÖ' ELSE 'Non chiffr√© ‚ö†Ô∏è' END AS Chiffrement,
    a.email_address,
    sp.name AS ProfileName
FROM msdb.dbo.sysmail_account a
LEFT JOIN msdb.dbo.sysmail_profileaccount spa ON a.account_id = spa.account_id
LEFT JOIN msdb.dbo.sysmail_profile sp ON spa.profile_id = sp.profile_id;


üëâ Si tu vois STARTTLS activ√© ‚úÖ + port 587, ta configuration est parfaite et s√©curis√©e.











Script SQL : Diagnostic complet Database Mail
/* =====================================================================
   üß© SQL Server - Diagnostic complet Database Mail
   Auteur : ChatGPT (GPT-5)
   Objectif : V√©rifier la configuration SMTP, le chiffrement TLS, 
              et d√©tecter les erreurs d‚Äôenvoi.
   Compatible : SQL Server 2012 ‚Üí 2022
   ===================================================================== */

SET NOCOUNT ON;

PRINT '===== üîç 1. V√©rification de la configuration Database Mail =====';

-- Comptes configur√©s
SELECT 
    a.account_id,
    a.name AS AccountName,
    a.email_address,
    a.mailserver_name AS SMTP_Server,
    a.port,
    CASE a.enable_ssl WHEN 1 THEN '‚úÖ STARTTLS activ√©' ELSE '‚ö†Ô∏è Non chiffr√©' END AS SSL_Status,
    a.username AS SMTP_Login,
    p.name AS ProfileName
FROM msdb.dbo.sysmail_account a
LEFT JOIN msdb.dbo.sysmail_profileaccount pa ON a.account_id = pa.account_id
LEFT JOIN msdb.dbo.sysmail_profile p ON pa.profile_id = p.profile_id
ORDER BY a.account_id;

PRINT ' ';
PRINT '===== ‚öôÔ∏è 2. Param√®tres globaux Database Mail =====';

SELECT name, value
FROM msdb.dbo.sysmail_configuration
ORDER BY name;

PRINT ' ';
PRINT '===== üì¨ 3. Derniers envois Database Mail =====';

SELECT TOP 20
    sent_status,
    recipients,
    subject,
    mailitem_id,
    CONVERT(VARCHAR(19), send_request_date, 120) AS SendRequestDate,
    CONVERT(VARCHAR(19), sent_date, 120) AS SentDate
FROM msdb.dbo.sysmail_allitems
ORDER BY mailitem_id DESC;

PRINT ' ';
PRINT '===== ‚ö†Ô∏è 4. Derniers √©v√©nements / erreurs Database Mail =====';

SELECT TOP 20
    log_date,
    event_type,
    CASE 
        WHEN event_type = 'error' THEN '‚ùå'
        WHEN event_type = 'warning' THEN '‚ö†Ô∏è'
        ELSE '‚úÖ'
    END AS StatusIcon,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

PRINT ' ';
PRINT '===== üßæ 5. R√©sum√© synth√©tique =====';

DECLARE 
    @nbAccounts INT,
    @nbProfiles INT,
    @nbErrors INT,
    @nbSuccess INT,
    @sslEnabled INT;

SELECT @nbAccounts = COUNT(*) FROM msdb.dbo.sysmail_account;
SELECT @nbProfiles = COUNT(*) FROM msdb.dbo.sysmail_profile;
SELECT @nbErrors = COUNT(*) FROM msdb.dbo.sysmail_event_log WHERE event_type = 'error';
SELECT @nbSuccess = COUNT(*) FROM msdb.dbo.sysmail_event_log WHERE event_type = 'success';
SELECT @sslEnabled = COUNT(*) FROM msdb.dbo.sysmail_account WHERE enable_ssl = 1;

PRINT ' ';
PRINT '===== üßÆ Synth√®se =====';
PRINT 'Nombre de comptes SMTP configur√©s : ' + CAST(@nbAccounts AS VARCHAR(10));
PRINT 'Nombre de profils Database Mail :  ' + CAST(@nbProfiles AS VARCHAR(10));
PRINT 'Comptes avec STARTTLS activ√© :     ' + CAST(@sslEnabled AS VARCHAR(10));
PRINT 'Derniers succ√®s d‚Äôenvoi :          ' + CAST(@nbSuccess AS VARCHAR(10));
PRINT 'Derni√®res erreurs d√©tect√©es :      ' + CAST(@nbErrors AS VARCHAR(10));

PRINT ' ';
PRINT '===== ‚úÖ Analyse finale =====';
IF @sslEnabled > 0 
    PRINT '‚úÖ Le chiffrement STARTTLS (port 587) est activ√© ‚Äî configuration conforme.';
ELSE 
    PRINT '‚ö†Ô∏è Attention : le chiffrement TLS n‚Äôest pas activ√© sur un ou plusieurs comptes SMTP.';

IF @nbErrors > 0
    PRINT '‚ö†Ô∏è Des erreurs r√©centes ont √©t√© d√©tect√©es dans les logs. Consulte les d√©tails ci-dessus.';
ELSE
    PRINT '‚úÖ Aucun probl√®me r√©cent d√©tect√© dans Database Mail.';

PRINT ' ';
PRINT '===== üïì Fin du diagnostic =====';




Ce que le script fait concr√®tement :
√âtape	V√©rifie	D√©tails
1Ô∏è‚É£	Comptes Database Mail	SMTP, port, SSL activ√© ou non, profil associ√©
2Ô∏è‚É£	Param√®tres globaux	Configurations g√©n√©rales de Database Mail
3Ô∏è‚É£	Derniers envois	Statut, date, destinataire, sujet
4Ô∏è‚É£	Logs r√©cents	Erreurs / warnings / succ√®s
5Ô∏è‚É£	R√©sum√© chiffr√©	Nb comptes, SSL activ√©, erreurs r√©centes
‚úÖ	Analyse automatique	Indique si ton config est conforme STARTTLS 587





üß© 1. Pr√©requis √† v√©rifier

Avant de configurer Database Mail avec STARTTLS :

√âl√©ment	V√©rification	Commande / Action
‚úÖ Database Mail activ√©	doit √™tre activ√© dans sp_configure	EXEC sp_configure 'Database Mail XPs';
‚úÖ Service Database Mail	doit √™tre d√©marr√©	Database Mail (DatabaseMail.exe) via SQL Server Agent
‚úÖ Port SMTP 587	doit √™tre ouvert vers ton serveur SMTP	Test-NetConnection smtp.exemple.com -Port 587
‚úÖ Compte SMTP valide	adresse, login, mot de passe	fournis par ton service mail (Office365, OVH, Gmail, etc.)
‚öôÔ∏è 2. Activer Database Mail dans l‚Äôinstance SQL Server
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'Database Mail XPs', 1;
RECONFIGURE;


‚úÖ Cela active le composant interne DatabaseMail.exe.

üß∞ 3. Cr√©er un compte SMTP STARTTLS (port 587)
‚Üí depuis SQL Server Management Studio (SSMS)

Ouvre :
Management ‚Üí Database Mail ‚Üí Configure Database Mail

Choisis :
‚ûú ‚ÄúSet up Database Mail by performing the following tasks‚Äù

Donne un nom √† ton profil (ex. Profil_SQL_SECURE)

Clique sur Add Account et configure :

Champ	Valeur √† renseigner
Account name	Compte_SMTP_SECURE
E-mail address	sqlserver@tondomaine.com
Display name	SQL Server
Server name	smtp.tonserveur.com
Port number	587
Requires SSL connection	‚úÖ Coch√©
Authentication	login/mot de passe SMTP

üí° Exemple :
Si tu utilises Office 365 :

Server name : smtp.office365.com

Port : 587

SSL : activ√©

üßÆ 4. (Option SQL) ‚Äî M√™me configuration en T-SQL

Si tu veux la faire en script (ex√©cutable dans un d√©ploiement automatis√©) :

EXEC msdb.dbo.sysmail_add_account_sp
    @account_name = 'Compte_SMTP_SECURE',
    @description = 'Compte mail SQL Server via STARTTLS (port 587)',
    @email_address = 'sqlserver@tondomaine.com',
    @display_name = 'SQL Server',
    @mailserver_name = 'smtp.tonserveur.com',
    @port = 587,
    @enable_ssl = 1,                -- STARTTLS activ√©
    @username = 'sqlserver@tondomaine.com',
    @password = 'TonMotDePasseIci';
GO

EXEC msdb.dbo.sysmail_add_profile_sp
    @profile_name = 'Profil_SQL_SECURE',
    @description = 'Profil Database Mail s√©curis√© STARTTLS';
GO

EXEC msdb.dbo.sysmail_add_profileaccount_sp
    @profile_name = 'Profil_SQL_SECURE',
    @account_name = 'Compte_SMTP_SECURE',
    @sequence_number = 1;
GO

EXEC msdb.dbo.sysmail_add_principalprofile_sp
    @profile_name = 'Profil_SQL_SECURE',
    @principal_id = 0,   -- public
    @is_default = 1;
GO

üì§ 5. Test d‚Äôenvoi d‚Äôun mail chiffr√©
EXEC msdb.dbo.sp_send_dbmail
    @profile_name = 'Profil_SQL_SECURE',
    @recipients = 'ton.email@exemple.com',
    @subject = '‚úÖ Test Database Mail STARTTLS (587)',
    @body = 'Envoi r√©ussi via SMTP STARTTLS s√©curis√©.';

üîç 6. V√©rification du r√©sultat
a) V√©rifie les logs Database Mail :
SELECT TOP 20 log_date, event_type, description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

b) V√©rifie l‚Äô√©tat du service :
EXEC msdb.dbo.sysmail_help_status_sp;


‚Üí doit renvoyer :
DatabaseMail.exe is started




‚úÖ 9. V√©rification finale (r√©sum√© express)

Ex√©cute ce mini-check pour confirmer :

SELECT
    a.name AS AccountName,
    a.mailserver_name AS SMTP_Server,
    a.port,
    CASE a.enable_ssl WHEN 1 THEN 'STARTTLS activ√© ‚úÖ' ELSE 'Non chiffr√© ‚ö†Ô∏è' END AS Chiffrement,
    a.email_address,
    p.name AS ProfileName
FROM msdb.dbo.sysmail_account a
JOIN msdb.dbo.sysmail_profileaccount pa ON a.account_id = pa.account_id
JOIN msdb.dbo.sysmail_profile p ON pa.profile_id = p.profile_id;


Si tu vois :

Port = 587 | Chiffrement = STARTTLS activ√© ‚úÖ


üéØ ‚Üí ton instance SQL Server est bien configur√©e pour envoyer des mails chiffr√©s STARTTLS.













üß© 1Ô∏è‚É£ Voir les comptes SMTP configur√©s
SELECT 
    account_id,
    name                AS AccountName,
    email_address,
    mailserver_name     AS SMTP_Server,
    port,
    CASE enable_ssl WHEN 1 THEN '‚úÖ STARTTLS activ√©' ELSE '‚ùå Non chiffr√©' END AS SSL_Status,
    username            AS SMTP_Login
FROM msdb.dbo.sysmail_account;


üëâ Tu verras ici :

le nom du compte Database Mail,

l‚Äôadresse exp√©ditrice,

le serveur SMTP et port (25, 465 ou 587),

si le chiffrement STARTTLS est activ√© (enable_ssl = 1).

üß© 2Ô∏è‚É£ Voir les profils Database Mail
SELECT 
    profile_id,
    name        AS ProfileName,
    description
FROM msdb.dbo.sysmail_profile;


Chaque profil peut regrouper un ou plusieurs comptes SMTP.

üß© 3Ô∏è‚É£ Voir les associations profil ‚Üî compte
SELECT 
    p.name AS ProfileName,
    a.name AS AccountName,
    pa.sequence_number
FROM msdb.dbo.sysmail_profileaccount pa
JOIN msdb.dbo.sysmail_profile p ON pa.profile_id = p.profile_id
JOIN msdb.dbo.sysmail_account a ON pa.account_id = a.account_id
ORDER BY p.name;


Cela montre quel profil utilise quel compte, et dans quel ordre (si tu en as plusieurs).

üß© 4Ô∏è‚É£ Voir les droits (qui peut utiliser quel profil)
SELECT 
    p.name AS ProfileName,
    pr.name AS PrincipalName,
    pp.is_default
FROM msdb.dbo.sysmail_principalprofile pp
JOIN msdb.dbo.sysmail_profile p ON pp.profile_id = p.profile_id
JOIN sys.database_principals pr ON pp.principal_id = pr.principal_id;


is_default = 1 indique le profil par d√©faut (celui utilis√© si aucun n‚Äôest pr√©cis√© dans sp_send_dbmail).

üß© 5Ô∏è‚É£ V√©rifier les derniers envois de mails
SELECT TOP 20
    mailitem_id,
    sent_status,
    recipients,
    subject,
    CONVERT(VARCHAR(19), send_request_date, 120) AS Requested,
    CONVERT(VARCHAR(19), sent_date, 120) AS Sent
FROM msdb.dbo.sysmail_allitems
ORDER BY mailitem_id DESC;

üß© 6Ô∏è‚É£ V√©rifier les logs d‚Äô√©v√©nements (erreurs, succ√®s)
SELECT TOP 20
    log_date,
    event_type,
    CASE 
        WHEN event_type = 'error' THEN '‚ùå'
        WHEN event_type = 'warning' THEN '‚ö†Ô∏è'
        ELSE '‚úÖ'
    END AS Status,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

üß© 7Ô∏è‚É£ V√©rifier l‚Äô√©tat du service Database Mail
EXEC msdb.dbo.sysmail_help_status_sp;


R√©sultat attendu :

DatabaseMail.exe is started

üßæ R√©sum√© rapide √† ex√©cuter (check complet)

Si tu veux un r√©sum√© express en une seule commande :

SELECT
    a.name AS AccountName,
    a.mailserver_name AS SMTP_Server,
    a.port,
    CASE a.enable_ssl WHEN 1 THEN '‚úÖ STARTTLS activ√©' ELSE '‚ö†Ô∏è Non chiffr√©' END AS TLS_Status,
    a.email_address,
    p.name AS ProfileName
FROM msdb.dbo.sysmail_account a
JOIN msdb.dbo.sysmail_profileaccount pa ON a.account_id = pa.account_id
JOIN msdb.dbo.sysmail_profile p ON pa.profile_id = p.profile_id
ORDER BY a.name;


üëâ Si tu vois :

Port = 587

TLS_Status = ‚úÖ STARTTLS activ√©

alors ta configuration est d√©j√† parfaitement conforme et s√©curis√©e.










‚úÖ Voici comment voir ta configuration Database Mail sur SQL Server 2017
1Ô∏è‚É£ Voir tous les comptes SMTP existants
EXEC msdb.dbo.sysmail_help_account_sp;


üîπ Tu obtiendras :

Le nom du compte (account_name)

L‚Äôadresse email (email_address)

Le serveur SMTP (mailserver_name)

Le port

Si SSL est activ√© (enable_ssl)

Le login utilis√© (username)

2Ô∏è‚É£ Voir les profils configur√©s
EXEC msdb.dbo.sysmail_help_profile_sp;

3Ô∏è‚É£ Voir les associations profil ‚Üî compte
EXEC msdb.dbo.sysmail_help_profileaccount_sp;

4Ô∏è‚É£ Voir le profil par d√©faut
EXEC msdb.dbo.sysmail_help_principalprofile_sp;

5Ô∏è‚É£ Voir les logs et l‚Äôhistorique des mails envoy√©s
SELECT TOP 20
    sent_status,
    recipients,
    subject,
    send_request_date,
    sent_date
FROM msdb.dbo.sysmail_allitems
ORDER BY mailitem_id DESC;


et les erreurs :

SELECT TOP 20
    log_date,
    event_type,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

üß† Interpr√©tation

V√©rifie dans le r√©sultat de sysmail_help_account_sp :

Champ	Ce que tu veux voir
mailserver_name	ton serveur SMTP (ex : smtp.office365.com)
port	587
enable_ssl	1 ‚Üí cela confirme que STARTTLS est activ√©

Si ces trois √©l√©ments correspondent,
‚û°Ô∏è ta configuration actuelle utilise d√©j√† SMTP STARTTLS sur le port 587, donc parfaite ‚úÖ





Script de diagnostic Database Mail pour SQL Server 2017
/* ===========================================================
   ‚úÖ Diagnostic Database Mail (compatible SQL Server 2017)
   =========================================================== */

-- 1Ô∏è‚É£ Comptes configur√©s
EXEC msdb.dbo.sysmail_help_account_sp;

-- 2Ô∏è‚É£ Profils Database Mail
EXEC msdb.dbo.sysmail_help_profile_sp;

-- 3Ô∏è‚É£ Association Profil ‚Üî Compte
EXEC msdb.dbo.sysmail_help_profileaccount_sp;

-- 4Ô∏è‚É£ Profil par d√©faut
EXEC msdb.dbo.sysmail_help_principalprofile_sp;

-- 5Ô∏è‚É£ Derniers envois
SELECT TOP 20
    mailitem_id,
    sent_status,
    recipients,
    subject,
    send_request_date,
    sent_date
FROM msdb.dbo.sysmail_allitems
ORDER BY mailitem_id DESC;

-- 6Ô∏è‚É£ Derniers √©v√©nements (erreurs, warnings, succ√®s)
SELECT TOP 20
    log_date,
    event_type,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

üß† Interpr√©tation du r√©sultat

Quand tu ex√©cutes :

EXEC msdb.dbo.sysmail_help_account_sp;


Tu obtiens un r√©sultat comme :

account_id	name	email_address	mailserver_name	port	enable_ssl	username
1	Compte_SMTP_SECURE	sqlserver@exemple.com
	smtp.office365.com	587	1	sqlserver@exemple.com

üîπ Si tu vois :

port = 587,

enable_ssl = 1,

‚û°Ô∏è Ton instance SQL Server utilise d√©j√† SMTP STARTTLS et la configuration est bonne ‚úÖ

üßæ R√©sum√©
Objectif	M√©thode
Voir comptes mail	EXEC msdb.dbo.sysmail_help_account_sp;
Voir profils	EXEC msdb.dbo.sysmail_help_profile_sp;
Voir liens profil ‚Üî compte	EXEC msdb.dbo.sysmail_help_profileaccount_sp;
Voir erreurs / logs	SELECT * FROM msdb.dbo.sysmail_event_log;




***************************************************************************

üß© 1Ô∏è‚É£ Comprendre ce que signifie le port 25
√âl√©ment	D√©tail
Port 25 (SMTP standard)	utilis√© pour l‚Äôenvoi inter-serveurs (MTA ‚Üî MTA) ou sans chiffrement
Chiffrement	‚ùå Aucun par d√©faut (les identifiants peuvent passer en clair)
Utilisation typique	Serveurs internes, relais SMTP locaux, environnements non expos√©s
Probl√®me courant	De plus en plus de fournisseurs (Microsoft, Gmail, OVH, etc.) bloquant le port 25 sortant ou refusant les connexions non chiffr√©es
üß† 2Ô∏è‚É£ Ce que √ßa implique pour ton SQL Server

Actuellement, ton instance :

Envoie ses mails en clair (sauf si ton serveur SMTP applique opportunistiquement STARTTLS c√¥t√© serveur),

Utilise un port 25 ouvert vers ton relais (souvent un serveur interne Exchange, Postfix ou IIS SMTP),

Fonctionne s√ªrement correctement car le serveur SMTP accepte la connexion sans TLS.

‚úÖ Conclusion :
Si ton serveur SMTP est interne et s√©curis√© (LAN), ce n‚Äôest pas un probl√®me.
Mais si tu veux envoyer des mails via un service externe (Microsoft 365, Gmail, OVH‚Ä¶),
‚û°Ô∏è il est pr√©f√©rable de passer sur le port 587 (STARTTLS).

‚öôÔ∏è 3Ô∏è‚É£ Comment savoir si le port 587 est disponible

Sur ton serveur SQL, lance dans PowerShell :

Test-NetConnection smtp.exemple.com -Port 587


‚Üí Si TcpTestSucceeded = True, c‚Äôest bon signe.
Sinon, le pare-feu ou le serveur SMTP bloque ce port.

üîÑ 4Ô∏è‚É£ Si ton fournisseur supporte STARTTLS (587)

Alors tu peux modifier ton compte Database Mail existant :

EXEC msdb.dbo.sysmail_update_account_sp
    @account_name = 'TonCompteSMTP',
    @mailserver_name = 'smtp.exemple.com',
    @port = 587,
    @enable_ssl = 1;   -- STARTTLS activ√©


Puis retester :

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = 'TonProfilMail',
    @recipients = 'toi@exemple.com',
    @subject = 'Test STARTTLS 587',
    @body = 'Email envoy√© avec chiffrement STARTTLS.';


‚úÖ Si l‚Äôenvoi r√©ussit, ta configuration est d√©sormais s√©curis√©e et conforme.

üöß 5Ô∏è‚É£ Si ton serveur ne supporte que le port 25

Deux cas :

üî∏ Tu utilises un relais interne ‚Üí pas besoin de changer, le trafic reste interne et s√ªr.

üî∏ Tu utilises un SMTP externe (Office 365, Gmail, etc.) ‚Üí il faudra migrer vers le port 587 STARTTLS (ou mettre en place un relais interne qui relaie vers le 587).

üßæ 6Ô∏è‚É£ V√©rifie ta configuration actuelle

Sur SQL Server 2017, ex√©cute :

EXEC msdb.dbo.sysmail_help_account_sp;


Et v√©rifie les colonnes :

mailserver_name	port	enable_ssl
smtp.exemple.com	25	0

üëâ Si enable_ssl = 0 et port = 25, tu es bien en SMTP non chiffr√©.

Souhaites-tu que je t‚Äôaide √† pr√©parer la migration de ton SQL Server de 25 vers 587 (STARTTLS),
en te donnant les √©tapes pr√©cises sans interruption de service (test, rollback possible, validation TLS) ?


üß≠ Objectif

Migrer ton Database Mail :

du port 25 (non chiffr√©)

vers le port 587 (STARTTLS)

avec chiffrement TLS actif

en testant et validant avant de basculer d√©finitivement

üß© √âtape 1 ‚Äî V√©rifier la configuration actuelle

Dans SSMS, ex√©cute :

EXEC msdb.dbo.sysmail_help_account_sp;


üëâ Note les valeurs suivantes :

account_name (nom du compte)

mailserver_name

port (actuellement 25)

enable_ssl (actuellement 0)

username

On va s‚Äôen servir pour dupliquer la config.

üß© √âtape 2 ‚Äî Cr√©er un nouveau compte test STARTTLS

Cr√©e une copie de ton compte actuel, mais en for√ßant TLS (port 587) :

EXEC msdb.dbo.sysmail_add_account_sp
    @account_name = 'Compte_SMTP_STARTTLS_TEST',
    @description  = 'Test STARTTLS sur port 587',
    @email_address = 'sqlserver@tondomaine.com',
    @display_name  = 'SQL Server',
    @mailserver_name = 'smtp.tondomaine.com',   -- ton serveur SMTP
    @port = 587,
    @enable_ssl = 1,                            -- STARTTLS
    @username = 'sqlserver@tondomaine.com',
    @password = 'TonMotDePasseSMTP';


‚ö†Ô∏è Ne touche pas √† ton compte actuel.
On cr√©e un compte parall√®le pour tester en toute s√©curit√©.

üß© √âtape 3 ‚Äî Associer ce compte √† un profil de test

Cr√©e un profil d√©di√© pour l‚Äôenvoi de test :

EXEC msdb.dbo.sysmail_add_profile_sp
    @profile_name = 'Profil_SMTP_STARTTLS_TEST',
    @description  = 'Profil Database Mail pour test STARTTLS';
GO

EXEC msdb.dbo.sysmail_add_profileaccount_sp
    @profile_name = 'Profil_SMTP_STARTTLS_TEST',
    @account_name = 'Compte_SMTP_STARTTLS_TEST',
    @sequence_number = 1;
GO

üß© √âtape 4 ‚Äî Tester un envoi chiffr√©
EXEC msdb.dbo.sp_send_dbmail
    @profile_name = 'Profil_SMTP_STARTTLS_TEST',
    @recipients = 'ton.email@exemple.com',
    @subject = '‚úÖ Test STARTTLS SQL Server',
    @body = 'Ce mail a √©t√© envoy√© depuis SQL Server via STARTTLS (port 587).';

üß© √âtape 5 ‚Äî V√©rifier le r√©sultat

Logs Database Mail :

SELECT TOP 10
    log_date,
    event_type,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;


üëâ Si tu vois :

Mail sent.


ou

Successfully sent e-mail message.


‚úÖ ton serveur SMTP accepte STARTTLS et SQL Server fonctionne bien sur 587.

üß© √âtape 6 ‚Äî Basculer le profil principal

Une fois le test valid√© :

1Ô∏è‚É£ Supprime (ou renomme) ton ancien compte sur port 25 :

EXEC msdb.dbo.sysmail_delete_account_sp @account_name = 'Compte_SMTP_25';


2Ô∏è‚É£ Renomme ton compte test√© en nom officiel :

EXEC msdb.dbo.sysmail_update_account_sp
    @account_name = 'Compte_SMTP_STARTTLS_TEST',
    @new_account_name = 'Compte_SMTP_SECURE';


3Ô∏è‚É£ Mets √† jour ton profil par d√©faut :

EXEC msdb.dbo.sysmail_update_profile_sp
    @profile_name = 'Profil_SQL_SECURE',
    @description  = 'Profil principal SQL Server avec STARTTLS 587';

üß© √âtape 7 ‚Äî (Optionnel) Rollback rapide

Si le test √©choue (pare-feu, serveur bloqu√©, etc.) :

EXEC msdb.dbo.sysmail_update_account_sp
    @account_name = 'Compte_SMTP_SECURE',
    @port = 25,
    @enable_ssl = 0;


‚û°Ô∏è Tu reviens imm√©diatement √† la config d‚Äôorigine, sans perte.

üß† √âtape 8 ‚Äî V√©rification finale
EXEC msdb.dbo.sysmail_help_account_sp;


Assure-toi d‚Äôavoir :

Champ	Valeur
port	587
enable_ssl	1
mailserver_name	ton serveur SMTP
‚úÖ R√©sum√© visuel
√âtape	Action	Commande principale
1	Lire config actuelle	sysmail_help_account_sp
2	Cr√©er un compte test (587 + SSL)	sysmail_add_account_sp
3	Cr√©er un profil test	sysmail_add_profile_sp
4	Envoyer un test STARTTLS	sp_send_dbmail
5	V√©rifier les logs	sysmail_event_log
6	Basculer apr√®s validation	sysmail_update_account_sp
7	Rollback si probl√®me	Port 25, SSL=0
8	V√©rification finale	sysmail_help_account_sp

****************************************************************************


Excellent üëå ‚Äî voici un script SQL complet pr√™t √† ex√©cuter pour migrer Database Mail de SMTP port 25 vers STARTTLS port 587 sur SQL Server 2017 (compatible aussi 2016/2019).
Il g√®re :
‚úÖ la d√©tection de ta config actuelle,
‚úÖ la cr√©ation d‚Äôun compte test 587 (STARTTLS),
‚úÖ le test d‚Äôenvoi,
‚úÖ la possibilit√© de rollback automatique si √©chec.

üß∞ Script SQL de migration Database Mail (port 25 ‚Üí 587 STARTTLS)
/* =====================================================================
   üß© Migration Database Mail SQL Server (2017)
   De SMTP port 25 ‚Üí STARTTLS port 587
   Auteur : ChatGPT (GPT-5)
   ===================================================================== */

SET NOCOUNT ON;
PRINT '=== üß≠ D√©but migration Database Mail vers STARTTLS (port 587) ===';

DECLARE 
    @OldAccountName SYSNAME,
    @OldServer NVARCHAR(256),
    @OldPort INT,
    @OldSSL BIT,
    @OldUser NVARCHAR(256),
    @NewAccountName SYSNAME = N'Compte_SMTP_STARTTLS_TEST',
    @NewProfileName SYSNAME = N'Profil_SMTP_STARTTLS_TEST',
    @TestMail NVARCHAR(256) = N'ton.email@exemple.com'; -- ‚Üê √† modifier

-- 1Ô∏è‚É£ R√©cup√©ration du compte existant
PRINT '‚è≥ Lecture de la configuration actuelle...';
DECLARE @Accounts TABLE (
    account_id INT,
    name NVARCHAR(128),
    email_address NVARCHAR(128),
    mailserver_name NVARCHAR(256),
    port INT,
    enable_ssl BIT,
    username NVARCHAR(128)
);

INSERT INTO @Accounts
EXEC msdb.dbo.sysmail_help_account_sp;

SELECT TOP 1
    @OldAccountName = name,
    @OldServer = mailserver_name,
    @OldPort = port,
    @OldSSL = enable_ssl,
    @OldUser = username
FROM @Accounts;

PRINT '‚û°Ô∏è Compte actuel : ' + ISNULL(@OldAccountName,'<non trouv√©>');
PRINT '‚û°Ô∏è Serveur SMTP  : ' + ISNULL(@OldServer,'?');
PRINT '‚û°Ô∏è Port actuel   : ' + CAST(ISNULL(@OldPort,0) AS NVARCHAR(10));
PRINT '‚û°Ô∏è SSL activ√©    : ' + CASE WHEN @OldSSL=1 THEN 'Oui' ELSE 'Non' END;

-- 2Ô∏è‚É£ Cr√©ation d‚Äôun compte test STARTTLS
PRINT '‚öôÔ∏è Cr√©ation du compte test STARTTLS (port 587)...';

BEGIN TRY
    EXEC msdb.dbo.sysmail_add_account_sp
        @account_name = @NewAccountName,
        @description  = 'Compte test STARTTLS (port 587)',
        @email_address = 'sqlserver@tondomaine.com',  -- √† modifier
        @display_name  = 'SQL Server',
        @mailserver_name = @OldServer,
        @port = 587,
        @enable_ssl = 1,
        @username = @OldUser,
        @password = 'TonMotDePasseSMTP';              -- √† modifier
END TRY
BEGIN CATCH
    PRINT '‚ö†Ô∏è Compte test d√©j√† existant ou erreur de cr√©ation : ' + ERROR_MESSAGE();
END CATCH;

-- 3Ô∏è‚É£ Cr√©ation d‚Äôun profil de test
BEGIN TRY
    EXEC msdb.dbo.sysmail_add_profile_sp
        @profile_name = @NewProfileName,
        @description  = 'Profil Database Mail test STARTTLS';
    EXEC msdb.dbo.sysmail_add_profileaccount_sp
        @profile_name = @NewProfileName,
        @account_name = @NewAccountName,
        @sequence_number = 1;
END TRY
BEGIN CATCH
    PRINT '‚ö†Ô∏è Profil test d√©j√† existant ou erreur : ' + ERROR_MESSAGE();
END CATCH;

-- 4Ô∏è‚É£ Test d‚Äôenvoi
PRINT 'üì§ Test d‚Äôenvoi de mail via STARTTLS (587)...';

BEGIN TRY
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = @NewProfileName,
        @recipients = @TestMail,
        @subject = '‚úÖ Test STARTTLS SQL Server',
        @body = 'Ce mail a √©t√© envoy√© via STARTTLS (port 587) depuis SQL Server.';
END TRY
BEGIN CATCH
    PRINT '‚ùå Erreur lors du test d‚Äôenvoi : ' + ERROR_MESSAGE();
END CATCH;

WAITFOR DELAY '00:00:10'; -- attente 10s pour log

-- 5Ô∏è‚É£ V√©rification des logs
PRINT 'üîç V√©rification du r√©sultat dans les logs...';
SELECT TOP 5 log_date, event_type, description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

-- 6Ô∏è‚É£ R√©sultat final
PRINT '=== üßæ R√©sum√© ===';
SELECT TOP 1
    CASE 
        WHEN event_type = 'error' THEN '‚ùå √âchec de l‚Äôenvoi STARTTLS'
        WHEN event_type = 'warning' THEN '‚ö†Ô∏è Avertissement'
        ELSE '‚úÖ Envoi STARTTLS r√©ussi'
    END AS R√©sultat,
    description
FROM msdb.dbo.sysmail_event_log
ORDER BY log_date DESC;

PRINT '=== üïì Fin du test STARTTLS ===';

üß™ Mode d‚Äôemploi

1Ô∏è‚É£ Modifie dans le script :

ton adresse d‚Äôexp√©diteur : sqlserver@tondomaine.com

ton login SMTP : @username

ton mot de passe SMTP

ton adresse de test (@TestMail)

2Ô∏è‚É£ Ex√©cute le script dans SSMS
‚Üí il cr√©e un compte test Compte_SMTP_STARTTLS_TEST et envoie un mail.
‚Üí le log te dira ‚Äú‚úÖ Envoi STARTTLS r√©ussi‚Äù si tout est bon.

3Ô∏è‚É£ Si le test est concluant, tu pourras ensuite :

-- Supprimer l‚Äôancien compte (port 25)
EXEC msdb.dbo.sysmail_delete_account_sp @account_name = 'AncienCompteSMTP';
-- Renommer le nouveau compte comme principal
EXEC msdb.dbo.sysmail_update_account_sp 
    @account_name = 'Compte_SMTP_STARTTLS_TEST',
    @new_account_name = 'Compte_SMTP_SECURE';

üßØ Rollback (si √©chec)

Si l‚Äôenvoi √©choue ou ton serveur refuse le port 587 :

EXEC msdb.dbo.sysmail_update_account_sp
    @account_name = 'Compte_SMTP_STARTTLS_TEST',
    @port = 25,
    @enable_ssl = 0;


‚û°Ô∏è retour imm√©diat √† ta config initiale (non chiffr√©e sur port 25).





